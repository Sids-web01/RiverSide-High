<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - RiverSide Academy</title>
  <style>/* ...existing code... */
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #f6f8fa;
  color: #222;
  margin: 0;
  padding: 0 0 40px 0;
}
h1, h2, h3 {
  color: #007acc;
  margin-top: 30px;
}
h1 {
  margin-top: 0;
  padding: 24px 0 8px 0;
  text-align: center;
  background: #fff;
  border-bottom: 1px solid #eaeaea;
}
form {
  background: #fff;
  padding: 18px 24px 18px 24px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  margin-bottom: 24px;
  max-width: 480px;
}
form label {
  display: block;
  margin: 12px 0 4px 0;
  font-weight: 500;
}
form input, form select {
  padding: 8px 10px;
  width: 100%;
  max-width: 340px;
  border: 1px solid #cfd8dc;
  border-radius: 5px;
  margin-bottom: 6px;
  font-size: 1rem;
  background: #f9f9f9;
  transition: border 0.2s;
}
form input:focus, form select:focus {
  border: 1.5px solid #007acc;
  outline: none;
  background: #fff;
}
button {
  background: #007acc;
  color: #fff;
  border: none;
  border-radius: 5px;
  padding: 8px 18px;
  font-size: 1rem;
  cursor: pointer;
  margin-right: 6px;
  margin-top: 8px;
  transition: background 0.2s;
}
button:hover, button:focus {
  background: #005fa3;
}
#status, #addGradeStatus {
  margin-top: 8px;
  font-weight: 500;
}
#addGradeStatus { color: #1b8a2f; }
#studentsTable {
  border-collapse: collapse;
  width: 100%;
  background: #fff;
  margin-top: 18px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  border-radius: 10px;
  overflow: hidden;
}
#studentsTable th, #studentsTable td {
  border: 1px solid #e0e0e0;
  padding: 10px 12px;
  text-align: left;
}
#studentsTable th {
  background: #007acc;
  color: #fff;
  font-weight: 600;
  font-size: 1.05rem;
}
#studentsTable tr:nth-child(even) {
  background: #f5faff;
}
#studentsTable tr:hover {
  background: #e3f2fd;
}
input[type="text"], input[type="number"], select {
  box-sizing: border-box;
}
#searchInput {
  margin: 18px 0 10px 0;
  padding: 8px 12px;
  border-radius: 5px;
  border: 1px solid #cfd8dc;
  font-size: 1rem;
  background: #f9f9f9;
  width: 300px;
}
#searchInput:focus {
  border: 1.5px solid #007acc;
  background: #fff;
}
#addGradesForm {
  margin-top: 40px;
  padding: 18px 24px;
  border: 1px solid #e0e0e0;
  border-radius: 10px;
  background: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}
#addGradesForm h2 {
  margin-top: 0;
  color: #007acc;
}
#editModal, #gradeModal {
  display: none;
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.35);
  justify-content: center; align-items: center;
  z-index: 1000;
}
#editModal .modal-content, #gradeModal .modal-content {
  background: #fff;
  padding: 28px 24px 20px 24px;
  border-radius: 12px;
  width: 400px;
  max-width: 95vw;
  max-height: 92vh;
  overflow-y: auto;
  box-shadow: 0 4px 24px rgba(0,0,0,0.12);
  position: relative;
}
#editImagePreview {
  max-width: 110px;
  max-height: 110px;
  margin-bottom: 10px;
  border: 1px solid #cfd8dc;
  display: block;
  object-fit: contain;
  border-radius: 6px;
  background: #f9f9f9;
}
@media (max-width: 600px) {
  form, #addGradesForm, #editModal .modal-content, #gradeModal .modal-content {
    max-width: 98vw;
    padding: 12px;
  }
  #studentsTable th, #studentsTable td {
    padding: 7px 4px;
    font-size: 0.97rem;
  }
}
::-webkit-scrollbar {
  width: 8px;
  background: #f0f0f0;
}
::-webkit-scrollbar-thumb {
  background: #cfd8dc;
  border-radius: 4px;
}
/* ...existing code... */
  </style>
</head>
<body>

  <h1>RiverSide Academy - Admin Panel</h1>

<!-- Add Student Form -->
<h2>Add Student</h2>
<form id="studentForm">
  <label>ID <input type="text" name="id" required /></label>
  <label>Password <input type="text" name="password" required /></label>
  <label>Name <input type="text" name="name" required /></label>
  <label>Gender
    <select name="gender">
      <option>Male</option>
      <option>Female</option>
    </select>
  </label>
  <label>Class <input type="text" name="class" required /></label>
  <label>Guardian <input type="text" name="guardian" /></label>
  <label>Teacher <input type="text" name="teacher" /></label>
  <label>Contact <input type="text" name="contact" /></label>
  <label>Image <input type="file" name="image" accept="image/*" required /></label>
  <label>Role
    <select name="role">
      <option>Student</option>
      <option>Admin</option>
    </select>
  </label>
  <button type="submit">Register</button>
</form>
<p id="status"></p>

<!-- Search students -->
<h2>All Students</h2>
<input
  type="text"
  id="searchInput"
  placeholder="Search by ID or Name"
  oninput="filterStudents()"
  style="width: 300px; margin-bottom: 10px; padding: 6px;"
/>
<table id="studentsTable">
  <thead>
    <tr>
      <th>ID</th><th>Name</th><th>Class</th><th>Role</th><th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Add Grades Form -->
<form id="addGradesForm">
  <h2>Add / Update Grades</h2>
  <label>
    Student:
    <select id="studentSelectForGrades" required>
      <!-- dynamically filled -->
    </select>
  </label>
  <label>
    Term:
    <select id="termSelectAdd" required>
      <option value="term1">Term 1</option>
      <option value="term2">Term 2</option>
      <option value="term3">Term 3</option>
    </select>
  </label>
  <label>
    Subject:
    <select id="subjectSelectAdd" required>
      <option value="math">Math</option>
      <option value="english">English</option>
      <option value="science">Science</option>
      <option value="socialStudies">Social Studies</option>
      <option value="history">History</option>
      <option value="geography">Geography</option>
      <option value="physics">Physics</option>
      <option value="chemistry">Chemistry</option>
      <option value="biology">Biology</option>
      <option value="ICT">ICT</option>
      <option value="religiousStudies">Religious Studies</option>
      <option value="music">Music</option>
      <option value="physicalEducation">Physical Education</option>
      <option value="art">Art</option>
    </select>
  </label>
  <label>
    Marks:
    <input type="number" id="marksInputAdd" min="0" max="100" required />
  </label>
  <label>
    Position:
    <input type="number" id="positionInputAdd" min="1" required />
  </label>
  <button type="submit">Add / Update Grade</button>
  <p id="addGradeStatus" style="color: green;"></p>
</form>

<!-- Edit Student Modal -->
<div id="editModal">
  <div class="modal-content">
    <h3>Edit Student</h3>
    <form id="editForm">
      <label>ID <input type="text" name="id" readonly /></label>
      <label>Password <input type="text" name="password" required /></label>
      <label>Name <input type="text" name="name" required /></label>
      <label>Gender
        <select name="gender">
          <option>Male</option>
          <option>Female</option>
        </select>
      </label>
      <label>Class <input type="text" name="class" required /></label>
      <label>Guardian <input type="text" name="guardian" /></label>
      <label>Teacher <input type="text" name="teacher" /></label>
      <label>Contact <input type="text" name="contact" /></label>
      <label>Role
        <select name="role">
          <option>Student</option>
          <option>Admin</option>
        </select>
      </label>
      <label>Current Image:</label>
      <img id="editImagePreview" alt="Current Image Preview" />
      <label>Upload New Image (optional): 
        <input type="file" name="image" accept="image/*" />
      </label>
      <button type="submit">Save Changes</button>
      <button type="button" onclick="closeEditModal()">Cancel</button>
    </form>
  </div>
</div>

<!-- Grade Modal -->
<div id="gradeModal">
  <div class="modal-content">
    <h3>Edit Grade</h3>
    <p><strong>ID:</strong> <span id="gradeModalID"></span></p>
    <label>Term:
      <select id="termSelect">
        <option value="term1">Term 1</option>
        <option value="term2">Term 2</option>
        <option value="term3">Term 3</option>
      </select>
    </label>
    <label>Subject:
      <select id="subjectSelect">
        <option value="math">Math</option>
        <option value="english">English</option>
        <option value="science">Science</option>
        <option value="socialStudies">Social Studies</option>
        <option value="history">History</option>
        <option value="geography">Geography</option>
        <option value="physics">Physics</option>
        <option value="chemistry">Chemistry</option>
        <option value="biology">Biology</option>
        <option value="ICT">ICT</option>
        <option value="religiousStudies">Religious Studies</option>
        <option value="music">Music</option>
        <option value="physicalEducation">Physical Education</option>
        <option value="art">Art</option>
      </select>
    </label>
    <label>Grade:
      <input type="number" id="gradeInput" min="0" max="100" />
    </label>
    <label>Position (Term):
      <input type="number" id="positionInput" min="1" />
    </label>
    <br />
    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
      <button onclick="saveGrade()">Save</button>
      <button onclick="closeGradeModal()">Cancel</button>
    </div>
  </div>
</div>


<script>
    const apiUrl = 'http://localhost:5000/api/students';

// Convert file to base64 string
function toBase64(file) {
  return new Promise((resolve, reject) => {
    if (!file) return resolve(null);
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = err => reject(err);
  });
}

// Load all students and show in table and studentSelectForGrades dropdown
async function loadStudents() {
  try {
    const res = await fetch(apiUrl);
    const students = await res.json();
    const tbody = document.querySelector('#studentsTable tbody');
    const studentSelect = document.getElementById('studentSelectForGrades');
    tbody.innerHTML = '';
    studentSelect.innerHTML = '<option value="">-- Select Student --</option>';

    students.forEach(student => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${student.ID}</td>
        <td>${student.name}</td>
        <td>${student.class || ''}</td>
        <td>${student.role}</td>
        <td>
          <button onclick="openEditModal('${student.ID}')">Edit</button>
          <button onclick="deleteStudent('${student.ID}')">Delete</button>
          <button onclick="openGradeModal('${student.ID}')">Grades</button>
        </td>
      `;
      tbody.appendChild(tr);

      // Add student to Add Grades dropdown
      studentSelect.innerHTML += `<option value="${student.ID}">${student.ID} - ${student.name}</option>`;
    });
  } catch (e) {
    alert('Failed to load students');
    console.error(e);
  }
}

// Filter students by ID or Name
function filterStudents() {
  const filter = document.getElementById('searchInput').value.toLowerCase();
  const rows = document.querySelectorAll('#studentsTable tbody tr');
  rows.forEach(row => {
    const id = row.cells[0].textContent.toLowerCase();
    const name = row.cells[1].textContent.toLowerCase();
    row.style.display = id.includes(filter) || name.includes(filter) ? '' : 'none';
  });
}

// Add student form submit handler
document.getElementById('studentForm').addEventListener('submit', async e => {
  e.preventDefault();
  const statusEl = document.getElementById('status');
  statusEl.textContent = 'Processing...';

  const form = e.target;
  const formData = new FormData(form);
  const imageFile = formData.get('image');
  const imageBase64 = await toBase64(imageFile);

  const data = {
    ID: formData.get('id').trim(),
    password: formData.get('password').trim(),
    name: formData.get('name').trim(),
    gender: formData.get('gender'),
    class: formData.get('class').trim(),
    guardian: formData.get('guardian').trim(),
    teacher: formData.get('teacher').trim(),
    contact: formData.get('contact').trim(),
    image: imageBase64,
    role: formData.get('role').toLowerCase(),
    marks: {}, // initialize empty marks
    positions: {} // initialize empty positions by term
  };

  try {
    const res = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });
    const result = await res.json();
    if (res.ok) {
      statusEl.textContent = 'Student added successfully!';
      form.reset();
      loadStudents();
    } else {
      statusEl.textContent = 'Error: ' + (result.message || 'Something went wrong');
    }
  } catch (err) {
    statusEl.textContent = 'Network error';
    console.error(err);
  }
});

// Delete student by ID
async function deleteStudent(id) {
  if (!confirm('Are you sure you want to delete this student?')) return;
  try {
    const res = await fetch(`${apiUrl}/${id}`, { method: 'DELETE' });
    const result = await res.json();
    alert(result.message);
    loadStudents();
  } catch (e) {
    alert('Failed to delete student');
    console.error(e);
  }
}

// Edit modal controls
const editModal = document.getElementById('editModal');
const editForm = document.getElementById('editForm');
const editImagePreview = document.getElementById('editImagePreview');
let currentEditStudent = null;

// Open edit modal and populate data
async function openEditModal(id) {
  try {
    const res = await fetch(apiUrl);
    const students = await res.json();
    const student = students.find(s => s.ID === id);
    if (!student) return alert('Student not found');

    currentEditStudent = student;

    editForm.id.value = student.ID;
    editForm.password.value = student.password;
    editForm.name.value = student.name;
    editForm.gender.value = student.gender;
    editForm.class.value = student.class || '';
    editForm.guardian.value = student.guardian || '';
    editForm.teacher.value = student.teacher || '';
    editForm.contact.value = student.contact || '';
    editForm.role.value = student.role;
    editImagePreview.src = student.image || '';

    editModal.style.display = 'flex';
  } catch (e) {
    alert('Failed to load student data');
    console.error(e);
  }
}

// Close edit modal
function closeEditModal() {
  editModal.style.display = 'none';
  currentEditStudent = null;
  editForm.reset();
  editImagePreview.src = '';
}

// Submit edit form to update student info
editForm.addEventListener('submit', async e => {
  e.preventDefault();
  const formData = new FormData(editForm);
  let imageBase64 = null;
  const file = formData.get('image');
  if (file && file.size > 0) {
    imageBase64 = await toBase64(file);
  }

  const data = {
    password: formData.get('password').trim(),
    name: formData.get('name').trim(),
    gender: formData.get('gender'),
    class: formData.get('class').trim(),
    guardian: formData.get('guardian').trim(),
    teacher: formData.get('teacher').trim(),
    contact: formData.get('contact').trim(),
    role: formData.get('role').toLowerCase(),
  };

  if (imageBase64) {
    data.image = imageBase64;
  }

  try {
    const res = await fetch(`${apiUrl}/${editForm.id.value}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });
    const result = await res.json();
    if (res.ok) {
      alert('Student updated successfully');
      closeEditModal();
      loadStudents();
    } else {
      alert('Error: ' + (result.message || 'Something went wrong'));
    }
  } catch (e) {
    alert('Network error');
    console.error(e);
  }
});

// Grade modal controls
const gradeModal = document.getElementById('gradeModal');
const gradeModalID = document.getElementById('gradeModalID');
const termSelect = document.getElementById('termSelect');
const subjectSelect = document.getElementById('subjectSelect');
const gradeInput = document.getElementById('gradeInput');
const positionInput = document.getElementById('positionInput');
let currentGradeStudentID = null;

// Helper to build marks key: subject + term number, e.g. math1 for term1
function getGradeKey(subject, term) {
  return subject + term.charAt(term.length - 1);
}

// Open grade modal and load student grades and positions
async function openGradeModal(id) {
  currentGradeStudentID = id;
  gradeModalID.textContent = id;

  try {
    const res = await fetch(apiUrl);
    const students = await res.json();
    const student = students.find(s => s.ID === id);
    if (!student) return alert('Student not found');

    // Reset selects to default
    termSelect.value = 'term1';
    subjectSelect.value = 'math';

    // Immediately update inputs for marks and positions for default term/subject
    updateGradePositionInputs(student);

    gradeModal.style.display = 'flex';
  } catch (e) {
    alert('Failed to load student data');
    console.error(e);
  }
}

// Update grade and position inputs when term or subject changes
async function updateGradePositionInputs(student) {
  const key = getGradeKey(subjectSelect.value, termSelect.value);
  const term = termSelect.value;

  const marks = student.marks || {};
  const positions = student.positions || {};

  gradeInput.value = marks[key] !== undefined ? marks[key] : '';
  positionInput.value = positions[term] !== undefined ? positions[term] : '';
}

termSelect.addEventListener('change', async () => {
  if (!currentGradeStudentID) return;
  try {
    const res = await fetch(apiUrl);
    const students = await res.json();
    const student = students.find(s => s.ID === currentGradeStudentID);
    if (!student) return;
    updateGradePositionInputs(student);
  } catch (e) {
    console.error(e);
  }
});

subjectSelect.addEventListener('change', async () => {
  if (!currentGradeStudentID) return;
  try {
    const res = await fetch(apiUrl);
    const students = await res.json();
    const student = students.find(s => s.ID === currentGradeStudentID);
    if (!student) return;
    updateGradePositionInputs(student);
  } catch (e) {
    console.error(e);
  }
});

// Save grade and position to backend
async function saveGrade() {
  if (!currentGradeStudentID) return alert('No student selected');
  const key = getGradeKey(subjectSelect.value, termSelect.value);
  const term = termSelect.value;

  const gradeVal = gradeInput.value.trim();
  const positionVal = positionInput.value.trim();

  if (gradeVal === '') return alert('Please enter a grade');
  if (positionVal === '') return alert('Please enter a position');

  try {
    // Fetch current student
    const res1 = await fetch(apiUrl);
    const students = await res1.json();
    const student = students.find(s => s.ID === currentGradeStudentID);
    if (!student) return alert('Student not found');

    if (!student.marks) student.marks = {};
    if (!student.positions) student.positions = {};

    student.marks[key] = Number(gradeVal);
    student.positions[term] = Number(positionVal); // position stored by term only

    const updateData = {
      marks: student.marks,
      positions: student.positions
    };

    const res2 = await fetch(`${apiUrl}/${currentGradeStudentID}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updateData),
    });

    const result = await res2.json();
    if (res2.ok) {
      alert('Grade and position saved successfully');
      closeGradeModal();
    } else {
      alert('Error: ' + (result.message || 'Failed to save grade'));
    }
  } catch (e) {
    alert('Network error');
    console.error(e);
  }
}

// Close grade modal
function closeGradeModal() {
  gradeModal.style.display = 'none';
  currentGradeStudentID = null;
  gradeInput.value = '';
  positionInput.value = '';
}

// Add Grades Form handling
const addGradesForm = document.getElementById('addGradesForm');
const addGradeStatus = document.getElementById('addGradeStatus');

addGradesForm.addEventListener('submit', async e => {
  e.preventDefault();
  addGradeStatus.textContent = '';
  const studentID = document.getElementById('studentSelectForGrades').value;
  const term = document.getElementById('termSelectAdd').value;
  const subject = document.getElementById('subjectSelectAdd').value;
  const marks = document.getElementById('marksInputAdd').value.trim();
  const position = document.getElementById('positionInputAdd').value.trim();

  if (!studentID) return alert('Please select a student');
  if (marks === '') return alert('Please enter marks');
  if (position === '') return alert('Please enter position');

  try {
    // Fetch current student data
    const res1 = await fetch(apiUrl);
    const students = await res1.json();
    const student = students.find(s => s.ID === studentID);
    if (!student) return alert('Student not found');

    if (!student.marks) student.marks = {};
    if (!student.positions) student.positions = {};

    const key = subject + term.charAt(term.length - 1);

    student.marks[key] = Number(marks);
    student.positions[term] = Number(position); // position stored by term only

    const updateData = {
      marks: student.marks,
      positions: student.positions
    };

    const res2 = await fetch(`${apiUrl}/${studentID}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updateData),
    });

    const result = await res2.json();
    if (res2.ok) {
      addGradeStatus.textContent = 'Grade and position added/updated successfully!';
      addGradesForm.reset();
    } else {
      alert('Error: ' + (result.message || 'Failed to add grade'));
    }
  } catch (e) {
    alert('Network error');
    console.error(e);
  }
});

// Initialize page
loadStudents();

// Close modals when clicking outside modal content
window.onclick = function(event) {
  if (event.target === editModal) closeEditModal();
  if (event.target === gradeModal) closeGradeModal();
};

</script>

</body>
</html>
